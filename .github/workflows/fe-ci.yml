name: FE CI/CD

on:
  push:
    branches: 
      - main
  pull_request:
    branches:
      - main

jobs:
  # ========== CI: Build ==========
  build:
    runs-on: ["self-hosted", "Linux", "X64"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # - name: Lint
      #   run: npm run lint

      - name: Build
        run: npm run build

  # ========== CI: Test ==========
  test:
    runs-on: ["self-hosted", "Linux", "X64"]
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test --if-present

      - name: Run test coverage
        run: npm run test:coverage --if-present

  # ========== CD: Deploy to VPS ==========
  deploy:
    runs-on: ["self-hosted", "Linux", "X64"]
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull latest code to VPS
        run: |
          cd /home/bacopilot/bacopilot/ba_copilot_frontend
          git pull origin main

      - name: Stop frontend container
        run: docker compose stop frontend || true
        working-directory: /home/bacopilot/bacopilot

      - name: Remove frontend container
        run: docker compose rm -f frontend || true
        working-directory: /home/bacopilot/bacopilot

      - name: Build frontend image
        run: docker compose build --no-cache frontend
        working-directory: /home/bacopilot/bacopilot

      - name: Start frontend container
        run: docker compose up -d frontend
        working-directory: /home/bacopilot/bacopilot

      - name: Cleanup old Docker images
        run: docker image prune -f

      - name: Health check
        run: |
          echo "Waiting for frontend container to start..."
          sleep 10
          docker ps | grep ba-copilot-frontend || echo "Warning: Frontend container may not be running"
